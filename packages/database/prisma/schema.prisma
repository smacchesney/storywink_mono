// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BookStatus {
  DRAFT
  GENERATING
  STORY_READY
  ILLUSTRATING
  COMPLETED
  FAILED
  PARTIAL
}

enum PageType {
  SINGLE
  SPREAD
}

model User {
  id            String         @id @default(cuid())
  clerkId       String         @unique
  email         String         @unique
  name          String?
  imageUrl      String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  books         Book[]
  assets        Asset[]
  profile       UserProfile?
  notifications Notification[]
  cartItems     CartItem[]
  printOrders   PrintOrder[]
}

model Book {
  id                String         @id @default(cuid())
  userId            String
  title             String
  status            BookStatus     @default(DRAFT)
  pageLength        Int // 8, 12, or 16
  artStyle          String?
  tone              String?
  typography        String?
  theme             String?
  keyCharacters     String?
  specialObjects    String?
  excitementElement String?
  coverAssetId      String?
  promptTokens      Int?
  completionTokens  Int?
  totalTokens       Int?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  pages             Page[]
  notifications     Notification[]
  cartItems         CartItem[]
  printOrders       PrintOrder[]
  characters        Character[]

  @@index([userId])
}

model Page {
  id         String @id @default(cuid())
  bookId     String
  pageNumber Int
  index      Int    @default(0)

  assetId String?
  asset   Asset?  @relation(fields: [assetId], references: [id])

  originalImageUrl  String?
  generatedImageUrl String?
  text              String?
  textConfirmed     Boolean? @default(false)
  illustrationNotes String?

  isTitlePage Boolean @default(false)

  pageType         PageType
  moderationStatus String   @default("PENDING")
  moderationReason String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  book             Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([bookId])
  @@index([assetId])
}

model Asset {
  id           String   @id @default(cuid())
  userId       String
  url          String
  thumbnailUrl String?
  publicId     String   @unique
  fileType     String
  size         Int
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  pages        Page[] // Add relation back to Page model
  characters   Character[]

  @@index([userId])
}

model UserProfile {
  id          String    @id @default(cuid())
  userId      String    @unique
  firstName   String?
  lastName    String?
  bio         String?
  dateOfBirth DateTime?
  location    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Notification model for in-app notifications (e.g., book completion)
model Notification {
  id        String   @id @default(cuid())
  userId    String
  bookId    String?
  type      String // 'BOOK_COMPLETED', 'BOOK_FAILED', 'BOOK_PARTIAL'
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book? @relation(fields: [bookId], references: [id], onDelete: SetNull)

  @@index([userId, read])
  @@index([createdAt])
}

// Worker diagnostic logging table
// Captures failure details that survive process crashes
model WorkerDiagnostic {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Job identification
  jobId       String
  jobType     String // 'story', 'illustration', 'finalize'
  attemptNum  Int // Current attempt number (1-5)
  maxAttempts Int // Total attempts allowed

  // Book/Page context
  bookId     String?
  pageId     String?
  pageNumber Int?

  // Error details
  errorType    String // 'missing_reference_url', 'gemini_error', 'fetch_error', etc.
  errorMessage String @db.Text
  errorStage   String // Where in the process it failed

  // STYLE_LIBRARY diagnostics (for missing referenceImageUrl errors)
  styleKey                  String?
  styleExists               Boolean?
  hasReferenceImageUrl      Boolean?
  referenceImageUrlType     String?
  referenceImageUrlValue    String?
  availableStyleKeys        String? // JSON array of keys

  // Container/environment info
  instanceId     String
  processId      Int
  hostname       String?
  railwayCommit  String?
  nodeVersion    String?

  @@index([jobId])
  @@index([bookId])
  @@index([pageId])
  @@index([errorType])
  @@index([createdAt])
}

// ═══════════════════════════════════════════════════════════════
// CHARACTER DETECTION: Face Detection & Character References
// ═══════════════════════════════════════════════════════════════

// Character model for face detection and character references
model Character {
  id              String   @id @default(cuid())
  bookId          String
  name            String
  croppedFaceUrl  String   // Cloudinary URL of cropped face
  sourceAssetId   String   // Which uploaded photo this face came from
  faceBounds      Json?    // { x, y, width, height } - for re-cropping if needed
  isMainCharacter Boolean  @default(true)
  displayOrder    Int      @default(0)
  createdAt       DateTime @default(now())

  book        Book  @relation(fields: [bookId], references: [id], onDelete: Cascade)
  sourceAsset Asset @relation(fields: [sourceAssetId], references: [id])

  @@index([bookId])
}

// ═══════════════════════════════════════════════════════════════
// PRINT-ON-DEMAND: Cart & Order Models
// ═══════════════════════════════════════════════════════════════

// Shopping cart for print orders (database-persisted)
model CartItem {
  id        String   @id @default(cuid())
  userId    String
  bookId    String
  quantity  Int      @default(1) // 1-10 copies

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([userId, bookId]) // One cart entry per book per user
  @@index([userId])
}

// Print order status enum
enum PrintOrderStatus {
  PENDING_PAYMENT   // Awaiting payment
  PAYMENT_COMPLETED // Payment successful, ready to submit to Lulu
  SUBMITTED_TO_LULU // Sent to Lulu API
  IN_PRODUCTION     // Lulu confirmed, being printed
  SHIPPED           // Order shipped with tracking
  DELIVERED         // Order delivered
  CANCELLED         // Order cancelled
  FAILED            // Order failed
}

// Print order for Lulu POD integration
model PrintOrder {
  id     String           @id @default(cuid())
  userId String
  bookId String
  status PrintOrderStatus @default(PENDING_PAYMENT)

  // Order details
  quantity Int @default(1) // 1-10 copies

  // Lulu-specific fields
  luluPrintJobId String? // Lulu's print job ID
  podPackageId   String? // e.g., "0850X0850FCSTDSS060UW444GXX"
  pageCount      Int? // Interior page count

  // PDF URLs (Dropbox-hosted, publicly accessible for Lulu)
  interiorPdfUrl String?
  coverPdfUrl    String?

  // Pricing (stored in cents to avoid floating point issues)
  printCost    Int? // Cost from Lulu for printing
  shippingCost Int? // Shipping cost from Lulu
  taxAmount    Int? // Tax amount
  totalAmount  Int? // Total charged to customer
  currency     String @default("USD")

  // Stripe payment fields
  stripeSessionId String? // Stripe Checkout session ID
  stripePaymentId String? // Stripe Payment Intent ID

  // Shipping address
  shippingName     String?
  shippingStreet1  String?
  shippingStreet2  String?
  shippingCity     String?
  shippingState    String?
  shippingPostcode String?
  shippingCountry  String  @default("SG")
  shippingPhone    String?
  contactEmail     String?
  shippingTier     String? // e.g., 'sg_my', 'sg_my_express' - maps to Lulu shipping level

  // Tracking information
  trackingNumber    String?
  trackingUrl       String?
  estimatedDelivery DateTime?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  paidAt      DateTime? // When payment was received
  submittedAt DateTime? // When submitted to Lulu
  shippedAt   DateTime? // When Lulu shipped
  deliveredAt DateTime? // When delivered

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([bookId])
  @@index([status])
  @@index([luluPrintJobId])
  @@index([stripeSessionId])
}

